<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiaoSUB 面板</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>tailwind.config = { theme: { extend: { colors: { primary: '#6366f1', secondary: '#ec4899', accent: '#1fb2a6', } } } }</script>
    <style>
        body { background-color: #0f172a; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); min-height: 100vh; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        textarea.code-editor { font-family: monospace; white-space: pre; overflow-wrap: normal; overflow-x: scroll; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="text-slate-200">
<div id="app">
    <div v-if="!isLoggedIn" class="fixed inset-0 z-[999] flex items-center justify-center bg-slate-900/90 backdrop-blur-sm">
        <div class="card w-96 glass-panel shadow-2xl border border-slate-600">
            <div class="card-body text-center">
                <div class="mb-4"><i class="fa-solid fa-shield-halved text-5xl text-primary"></i></div>
                <h2 class="text-2xl font-bold text-white mb-2">安全验证</h2>
                <input type="password" v-model="loginPassword" @keyup.enter="handleLogin" placeholder="管理员密码" class="input input-bordered w-full bg-slate-800 text-center mb-4" />
                <button @click="handleLogin" class="btn btn-primary w-full" :disabled="loginLoading">{{ loginLoading ? '验证中...' : '解锁' }}</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl transition-all duration-500" :class="{ 'blur-sm pointer-events-none': !isLoggedIn }">
        <div class="navbar glass-panel rounded-2xl mb-8 shadow-xl">
            <div class="flex-1"><a class="btn btn-ghost normal-case text-2xl font-bold text-white"><i class="fa-solid fa-bolt text-yellow-400 mr-2"></i> BiaoSUB</a></div>
            <div class="flex-none gap-2">
                <button @click="openTemplateModal" class="btn btn-circle btn-ghost tooltip tooltip-bottom" data-tip="全局模板"><i class="fa-solid fa-file-code text-xl"></i></button>
                <button @click="openSettings" class="btn btn-circle btn-ghost tooltip tooltip-bottom" data-tip="设置"><i class="fa-solid fa-gear text-xl"></i></button>
                <button @click="logout" class="btn btn-circle btn-ghost text-red-400 tooltip tooltip-bottom" data-tip="退出"><i class="fa-solid fa-power-off text-xl"></i></button>
            </div>
        </div>

        <div class="tabs tabs-boxed bg-slate-800/50 mb-6 p-1">
            <a class="tab tab-lg flex-1" :class="{'tab-active bg-primary text-white': currentTab === 'resources'}" @click="currentTab = 'resources'"><i class="fa-solid fa-database mr-2"></i> 资源池</a>
            <a class="tab tab-lg flex-1" :class="{'tab-active bg-accent text-white': currentTab === 'groups'}" @click="currentTab = 'groups'"><i class="fa-solid fa-layer-group mr-2"></i> 聚合订阅组</a>
        </div>

        <div v-show="currentTab === 'resources'">
            <div class="flex justify-between items-center mb-4">
                <div class="text-sm text-slate-400">所有原始订阅和自建节点</div>
                <button @click="openResourceModal()" class="btn btn-primary btn-sm"><i class="fa-solid fa-plus"></i> 添加资源</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="resource-list">
                <div v-for="item in resources" :key="item.id" class="card bg-slate-800/50 border border-slate-700 shadow-xl">
                    <div class="card-body p-5">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="card-title text-base">{{ item.name }} <span class="badge badge-sm" :class="item.type==='node'?'badge-secondary':'badge-primary'">{{ item.type }}</span></h2>
                                <p class="text-xs text-slate-500 font-mono mt-1 break-all line-clamp-1">{{ item.url }}</p>
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <button @click="refreshResource(item)" class="btn btn-xs btn-circle btn-ghost" :class="{'loading': item.refreshing}" title="刷新订阅信息"><i v-if="!item.refreshing" class="fa-solid fa-rotate"></i></button>
                            </div>
                        </div>
                        
                        <div v-if="item.info && item.info.stats" class="mt-3 bg-slate-900/50 rounded-lg p-3 text-xs text-slate-400">
                            <div class="flex justify-between items-center mb-1">
                                <span>已用: <span class="text-white">{{ item.info.stats.used }}</span></span>
                                <span>总计: <span class="text-white">{{ item.info.stats.total }}</span></span>
                            </div>
                            <progress class="progress w-full h-1.5 mb-2" :class="getProgressClass(item.info.stats.percent)" :value="item.info.stats.percent || 0" max="100"></progress>
                            <div class="flex justify-between">
                                <span>使用率: {{ item.info.stats.percent }}%</span>
                                <span :class="{'text-red-400': isExpired(item.info.stats.raw_expire)}">过期: {{ item.info.stats.expire }}</span>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-slate-500 text-right">
                            包含节点: <span class="text-white font-bold">{{ item.info ? (item.info.nodeCount || 0) : 0 }}</span> 个
                        </div>

                        <div class="card-actions justify-end mt-4">
                            <button @click="previewNodes(item)" class="btn btn-xs btn-ghost">预览节点</button>
                            <button @click="editResource(item)" class="btn btn-xs btn-ghost">编辑</button>
                            <button @click="deleteResource(item.id)" class="btn btn-xs btn-ghost text-error">删除</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'groups'">
            <div class="flex justify-between items-center mb-4">
                <div class="text-sm text-slate-400">创建独立的订阅链接，按需组合资源</div>
                <button @click="openGroupModal()" class="btn btn-accent btn-sm text-white"><i class="fa-solid fa-plus"></i> 新建聚合组</button>
            </div>
            <div class="grid grid-cols-1 gap-6">
                <div v-for="group in groups" :key="group.id" class="card bg-slate-800/50 border border-slate-700 shadow-xl">
                    <div class="card-body p-5">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="card-title text-lg text-accent">{{ group.name }}</h2>
                                <div class="text-xs text-slate-500 mt-1">包含资源: <span class="text-slate-300">{{ group.config.length }}</span> 个</div>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button @click="copyGroupLink(group, 'clash')" class="btn btn-sm bg-[#1e1e1e] hover:bg-[#2d2d2d] text-slate-500 border-slate-600 cursor-not-allowed opacity-50" title="暂不可用"><i class="fa-solid fa-cat"></i> Clash</button>
                                <button @click="copyGroupLink(group, 'base64')" class="btn btn-sm bg-[#1e1e1e] hover:bg-[#2d2d2d] text-indigo-500 border-slate-600"><i class="fa-solid fa-paper-plane"></i> V2Ray</button>
                                <button @click="refreshToken(group)" class="btn btn-sm btn-ghost text-warning" title="刷新密钥"><i class="fa-solid fa-key"></i></button>
                                <button @click="editGroup(group)" class="btn btn-sm btn-ghost"><i class="fa-solid fa-pen"></i></button>
                                <button @click="deleteGroup(group.id)" class="btn btn-sm btn-ghost text-error"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="divider my-1"></div>
                        <div class="flex flex-wrap gap-2">
                            <span v-for="conf in group.config" :key="conf.subId" class="badge badge-neutral text-xs">
                                {{ getResourceName(conf.subId) }}
                                <span v-if="Array.isArray(conf.include)" class="ml-1 text-accent">({{ conf.include.length }})</span>
                                <span v-else class="ml-1 text-slate-500">(全)</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <dialog class="modal" :class="{ 'modal-open': resourceModal.show }">
            <div class="modal-box bg-slate-800 border border-slate-700">
                <h3 class="font-bold text-lg text-white mb-4">{{ resourceModal.isEdit ? '编辑资源' : '添加资源' }}</h3>
                <div class="flex flex-col gap-4">
                    <input type="text" v-model="resourceForm.name" placeholder="资源名称 (如: 某某机场)" class="input input-bordered w-full bg-slate-900" />
                    <div class="tabs tabs-boxed bg-slate-900">
                        <a class="tab flex-1" :class="{'tab-active': resourceForm.type==='subscription'}" @click="resourceForm.type='subscription'">订阅链接</a>
                        <a class="tab flex-1" :class="{'tab-active': resourceForm.type==='node'}" @click="resourceForm.type='node'">自建节点</a>
                    </div>
                    <textarea v-if="resourceForm.type==='node'" v-model="resourceForm.url" placeholder="vmess://..." class="textarea textarea-bordered h-32 bg-slate-900"></textarea>
                    <input v-else type="text" v-model="resourceForm.url" placeholder="https://..." class="input input-bordered w-full bg-slate-900" />
                </div>
                <div class="modal-action">
                    <button class="btn btn-ghost" @click="resourceModal.show=false">取消</button>
                    <button class="btn btn-primary" @click="saveResource" :disabled="submitting">保存</button>
                </div>
            </div>
        </dialog>

        <dialog class="modal" :class="{ 'modal-open': groupModal.show }">
            <div class="modal-box bg-slate-800 border border-slate-700 max-w-3xl">
                <h3 class="font-bold text-lg text-white mb-4">{{ groupModal.isEdit ? '编辑聚合组' : '新建聚合组' }}</h3>
                <div class="flex flex-col gap-4">
                    <input type="text" v-model="groupForm.name" placeholder="聚合组名称 (如: 我的主力订阅)" class="input input-bordered w-full bg-slate-900" />
                    
                    <div class="text-sm text-slate-400 mt-2">选择要包含的资源：</div>
                    <div class="max-h-96 overflow-y-auto custom-scrollbar bg-slate-900 rounded-lg border border-slate-700 p-2">
                        <div v-for="res in resources" :key="res.id" class="flex items-center justify-between p-3 border-b border-slate-800 last:border-none hover:bg-slate-800/50">
                            <label class="flex items-center gap-3 cursor-pointer flex-1">
                                <input type="checkbox" :checked="isResSelected(res.id)" @change="toggleResSelection(res.id)" class="checkbox checkbox-accent checkbox-sm" />
                                <span>{{ res.name }}</span>
                                <span class="badge badge-xs" :class="res.type==='node'?'badge-secondary':'badge-primary'">{{ res.type }}</span>
                            </label>
                            
                            <div v-if="isResSelected(res.id)" class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">
                                    {{ getResSelectionCount(res.id) }}
                                </span>
                                <button @click="openNodeSelector(res)" class="btn btn-xs btn-outline btn-accent">筛选节点</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-action">
                    <button class="btn btn-ghost" @click="groupModal.show=false">取消</button>
                    <button class="btn btn-accent text-white" @click="saveGroup" :disabled="submitting">保存聚合组</button>
                </div>
            </div>
        </dialog>

        <dialog class="modal" :class="{ 'modal-open': nodeSelector.show }">
            <div class="modal-box bg-slate-800 border border-slate-700">
                <h3 class="font-bold text-lg text-white mb-2">筛选节点: {{ nodeSelector.resourceName }}</h3>
                <div v-if="nodeSelector.loading" class="py-10 text-center"><span class="loading loading-spinner text-accent"></span> 加载中...</div>
                <div v-else>
                    <div class="flex justify-between mb-2">
                        <button @click="nodeSelector.selected = 'all'" class="btn btn-xs btn-ghost text-accent">全选 (默认)</button>
                        <button @click="nodeSelector.selected = []" class="btn btn-xs btn-ghost text-warning">清空</button>
                    </div>
                    <div class="max-h-80 overflow-y-auto custom-scrollbar bg-slate-900 rounded p-2">
                        <label v-for="node in nodeSelector.nodes" :key="node.name" class="flex items-center gap-2 p-2 hover:bg-slate-800 cursor-pointer">
                            <input type="checkbox" :value="node.name" v-model="nodeSelector.tempSelected" class="checkbox checkbox-xs checkbox-accent" />
                            <span class="text-xs text-slate-300 truncate">{{ node.name }}</span>
                        </label>
                    </div>
                </div>
                <div class="modal-action">
                    <button class="btn btn-ghost" @click="nodeSelector.show=false">取消</button>
                    <button class="btn btn-accent" @click="confirmNodeSelection">确认选择</button>
                </div>
            </div>
        </dialog>

        <dialog class="modal" :class="{ 'modal-open': previewModal.show }">
            <div class="modal-box bg-slate-800 border border-slate-700">
                <h3 class="font-bold text-lg text-white mb-4">节点预览</h3>
                <div class="max-h-96 overflow-y-auto bg-slate-900 rounded p-2">
                    <div v-for="node in previewModal.nodes" class="text-xs text-slate-400 border-b border-slate-700 py-2">
                        <div class="flex justify-between items-center">
                            <span class="text-white font-bold truncate pr-2">{{ node.name }}</span>
                            <button @click="copyText(node.link)" class="btn btn-square btn-xs btn-ghost text-accent"><i class="fa-regular fa-copy"></i></button>
                        </div>
                        <div class="font-mono mt-1 truncate opacity-50">{{ node.link }}</div>
                    </div>
                </div>
                <div class="modal-action">
                    <button class="btn btn-secondary btn-sm" @click="copyAllPreviewNodes">复制全部链接</button>
                    <button class="btn btn-ghost btn-sm" @click="previewModal.show=false">关闭</button>
                </div>
            </div>
        </dialog>

        <dialog class="modal" :class="{ 'modal-open': showTemplateModal }">
            <div class="modal-box bg-slate-800 border border-slate-700 w-11/12 max-w-5xl h-5/6 flex flex-col p-0">
                <div class="flex justify-between items-center p-4 bg-slate-900 border-b border-slate-700">
                    <h3 class="font-bold text-lg text-white">全局 Clash 模板</h3>
                    <button class="btn btn-sm btn-circle btn-ghost" @click="showTemplateModal=false">✕</button>
                </div>
                <textarea v-model="templateContent" class="code-editor w-full h-full bg-[#1e1e1e] text-slate-300 p-4 outline-none resize-none text-sm"></textarea>
                <div class="p-4 bg-slate-900 border-t border-slate-700 flex justify-end gap-2">
                    <button class="btn btn-primary" @click="saveTemplate">保存配置</button>
                </div>
            </div>
        </dialog>

        <div v-if="toast.show" class="toast toast-bottom toast-end z-50"><div class="alert shadow-lg text-white" :class="toast.type === 'success' ? 'alert-success' : 'alert-error'"><span>{{ toast.message }}</span></div></div>
    </div>
</div>

<script>
const { createApp, ref, reactive } = Vue
const API = '/api'

createApp({
    setup() {
        const isLoggedIn = ref(false); const loginPassword = ref(''); const loginLoading = ref(false)
        const currentTab = ref('resources')
        const resources = ref([]); const groups = ref([])
        const submitting = ref(false)
        const toast = reactive({ show: false, message: '', type: 'success' })
        
        // Modals
        const resourceModal = reactive({ show: false, isEdit: false }); const resourceForm = ref({ name: '', url: '', type: 'subscription' })
        const groupModal = reactive({ show: false, isEdit: false }); const groupForm = ref({ id: null, name: '', config: [] })
        const nodeSelector = reactive({ show: false, loading: false, resourceId: null, resourceName: '', nodes: [], selected: 'all', tempSelected: [] })
        const previewModal = reactive({ show: false, nodes: [] })
        const showTemplateModal = ref(false); const templateContent = ref('')

        const authFetch = async (url, opts = {}) => {
            opts.headers = { 'Authorization': localStorage.getItem('biaosub_token'), 'Content-Type': 'application/json', ...opts.headers }
            const res = await fetch(url, opts); if(res.status===401) { isLoggedIn.value=false; return null; } return res
        }
        const showToast = (msg, type='success') => { toast.message=msg; toast.type=type; toast.show=true; setTimeout(()=>toast.show=false, 3000) }
        const copyText = (txt) => navigator.clipboard.writeText(txt).then(()=>showToast('已复制'))

        const handleLogin = async () => {
            loginLoading.value = true
            const res = await fetch(API+'/login', { method: 'POST', body: JSON.stringify({password: loginPassword.value}) })
            if((await res.json()).success) { localStorage.setItem('biaosub_token', loginPassword.value); isLoggedIn.value=true; initData() }
            else showToast('密码错误', 'error')
            loginLoading.value = false
        }

        const initData = () => { loadResources(); loadGroups() }
        const loadResources = async () => { const res=await authFetch(API+'/subs'); if(res) resources.value = (await res.json()).data }
        const loadGroups = async () => { const res=await authFetch(API+'/groups'); if(res) groups.value = (await res.json()).data }

        // 辅助函数
        const getProgressClass = (p) => p > 90 ? 'progress-error' : (p > 75 ? 'progress-warning' : 'progress-primary')
        const isExpired = (ts) => ts ? Date.now() > ts * 1000 : false

        // Resource Actions
        const openResourceModal = () => { resourceForm.value = { name: '', url: '', type: 'subscription' }; resourceModal.isEdit = false; resourceModal.show = true }
        const editResource = (item) => { resourceForm.value = {...item}; resourceModal.isEdit = true; resourceModal.show = true }
        const saveResource = async () => {
            submitting.value = true
            const method = resourceModal.isEdit ? 'PUT' : 'POST'
            const url = resourceModal.isEdit ? `${API}/subs/${resourceForm.value.id}` : `${API}/subs`
            // 每次保存都触发一次 Check 获取 info
            let info = null;
            if (resourceForm.value.url) {
                try {
                    const checkRes = await authFetch(API+'/check', { method: 'POST', body: JSON.stringify({url: resourceForm.value.url, type: resourceForm.value.type}) });
                    const d = await checkRes.json();
                    if (d.success) info = d.data;
                } catch(e) {}
            }
            const payload = { ...resourceForm.value, info };
            await authFetch(url, { method, body: JSON.stringify(payload) })
            resourceModal.show = false; submitting.value = false; loadResources()
        }
        const deleteResource = async (id) => { if(confirm('删除资源?')) { await authFetch(`${API}/subs/${id}`, { method: 'DELETE' }); loadResources() } }
        const refreshResource = async (item) => { 
            item.refreshing = true; 
            const res = await authFetch(API+'/check', { method: 'POST', body: JSON.stringify({url: item.url, type: item.type}) })
            const d = await res.json()
            if(d.success) {
                // 更新 info 和 updated_at
                await authFetch(`${API}/subs/${item.id}`, { method: 'PUT', body: JSON.stringify({info: d.data}) })
                showToast('刷新成功')
            } else {
                showToast('刷新失败', 'error')
            }
            item.refreshing = false; loadResources()
        }

        // Group Actions
        const openGroupModal = () => { groupForm.value = { name: '', config: [] }; groupModal.isEdit = false; groupModal.show = true }
        const editGroup = (g) => { groupForm.value = JSON.parse(JSON.stringify(g)); groupModal.isEdit = true; groupModal.show = true }
        const isResSelected = (id) => groupForm.value.config.some(c => c.subId === id)
        const getResSelectionCount = (id) => {
            const c = groupForm.value.config.find(x => x.subId === id)
            return (c && Array.isArray(c.include)) ? `已选 ${c.include.length} 个` : '包含所有'
        }
        const toggleResSelection = (id) => {
            const idx = groupForm.value.config.findIndex(x => x.subId === id)
            if (idx > -1) groupForm.value.config.splice(idx, 1)
            else groupForm.value.config.push({ subId: id, include: 'all' }) // 默认为 "all" (非数组)
        }
        const getResourceName = (id) => resources.value.find(r => r.id === id)?.name || '未知资源'

        // Node Selector
        const openNodeSelector = async (res) => {
            nodeSelector.resourceId = res.id; nodeSelector.resourceName = res.name; nodeSelector.show = true; nodeSelector.loading = true
            // 查找当前配置
            const currentConf = groupForm.value.config.find(c => c.subId === res.id)
            
            // 加载节点
            const checkRes = await authFetch(API+'/check', { method: 'POST', body: JSON.stringify({url: res.url, type: res.type}) })
            const d = await checkRes.json()
            if(d.success && d.data.nodes) {
                nodeSelector.nodes = d.data.nodes
                // 恢复选中状态
                if (currentConf && Array.isArray(currentConf.include)) {
                    nodeSelector.selected = 'select'
                    nodeSelector.tempSelected = [...currentConf.include]
                } else {
                    nodeSelector.selected = 'all'
                    nodeSelector.tempSelected = d.data.nodes.map(n => n.name) // 默认全选 UI
                }
            } else {
                showToast('加载节点失败', 'error')
            }
            nodeSelector.loading = false
        }
        const confirmNodeSelection = () => {
            const idx = groupForm.value.config.findIndex(x => x.subId === nodeSelector.resourceId)
            if (idx > -1) {
                // 如果选择全部，config.include 设为字符串 'all'，否则设为数组
                if (nodeSelector.selected === 'all') {
                    groupForm.value.config[idx].include = 'all'
                } else {
                    groupForm.value.config[idx].include = nodeSelector.tempSelected
                }
            }
            nodeSelector.show = false
        }

        const saveGroup = async () => {
            submitting.value = true
            const method = groupModal.isEdit ? 'PUT' : 'POST'
            const url = groupModal.isEdit ? `${API}/groups/${groupForm.value.id}` : `${API}/groups`
            await authFetch(url, { method, body: JSON.stringify(groupForm.value) })
            groupModal.show = false; submitting.value = false; loadGroups()
        }
        const deleteGroup = async (id) => { if(confirm('删除此聚合组?')) { await authFetch(`${API}/groups/${id}`, { method: 'DELETE' }); loadGroups() } }
        const refreshToken = async (g) => { if(confirm('刷新密钥将导致旧链接失效，确定?')) { await authFetch(`${API}/groups/${g.id}`, { method: 'PUT', body: JSON.stringify({refresh_token: true}) }); loadGroups() } }
        
        const copyGroupLink = (g, type) => {
            const baseUrl = window.location.origin + '/api/g/' + g.token
            const url = type === 'clash' ? baseUrl + '?format=clash' : baseUrl
            copyText(url)
        }

        // Other
        const previewNodes = async (item) => {
            const res = await authFetch(API+'/check', { method: 'POST', body: JSON.stringify({url: item.url, type: item.type}) })
            const d = await res.json(); if(d.success) { previewModal.nodes = d.data.nodes; previewModal.show = true } else { showToast('预览失败', 'error') }
        }
        const copyAllPreviewNodes = () => { copyText(previewModal.nodes.map(n => n.link).join('\n')) }

        const openTemplateModal = async () => {
            const res = await authFetch(API+'/template/default'); const d = await res.json();
            templateContent.value = d.data || ''; showTemplateModal.value = true
        }
        const saveTemplate = async () => {
            await authFetch(API+'/template/default', { method: 'POST', body: JSON.stringify({content: templateContent.value}) })
            showTemplateModal.value = false; showToast('模板已保存')
        }
        
        // Settings Stub
        const openSettings = () => showToast('功能开发中...') // 简化展示
        const logout = () => { localStorage.removeItem('biaosub_token'); isLoggedIn.value = false }

        if(localStorage.getItem('biaosub_token')) { isLoggedIn.value = true; initData() }

        return {
            isLoggedIn, loginPassword, loginLoading, handleLogin, logout,
            currentTab, resources, groups, submitting, toast,
            resourceModal, resourceForm, openResourceModal, editResource, saveResource, deleteResource, refreshResource,
            groupModal, groupForm, openGroupModal, editGroup, saveGroup, deleteGroup, refreshToken, copyGroupLink,
            isResSelected, getResSelectionCount, toggleResSelection, getResourceName,
            nodeSelector, openNodeSelector, confirmNodeSelection,
            previewModal, previewNodes, copyText, copyAllPreviewNodes,
            showTemplateModal, openTemplateModal, templateContent, saveTemplate, openSettings,
            getProgressClass, isExpired
        }
    }
}).mount('#app')
</script>
</body>
</html>
